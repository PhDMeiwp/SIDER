---
title: "Introduction to FestR"
author: "Kevin Healy, Thomas Guillerme & Andrew L Jackson"
date: "6 April 2016"
output: pdf_document
---


This package is based on the \href{http://cran.r-project.org/web/packages/MCMCglmm/index.html}{\texttt{MCMCglmm} package} and runs a MCMCglmm analysis on multiple trees using the
\href{https://github.com/TGuillerme/mulTree}{\texttt{MulTree} package}.

\section{Installation}
To install \texttt{FestR} its dependancy \href{https://github.com/TGuillerme/mulTree}{\texttt{MulTree} package} must first be installed directly from GitHub using the following:

```{r install_mulTree, results="hide", message=FALSE}
if(!require(devtools)) install.packages("devtools")
install_github("TGuillerme/mulTree", ref = "master")
```


Follwong this you can then install \texttt{FestR} directly from GitHub using the following:
```{r install_FestR, results="hide", message=FALSE}
install_github("healyke/FestR", ref = "master")
```

And load in the data
```{r load_pakages, results="hide", message=FALSE, warning=FALSE}
library(mulTree)
library(FestR)
```

## Read in the data
```{r}

#read in the data
mydata<-read.csv(file=system.file("extdata", "FestR_data.csv", package = "FestR"),
 header=T, stringsAsFactors = F)

# re-oprder it into species
mydata <- mydata[order(mydata$species),]

#read in the phylogentic information
#first the mammal trees
mammal_trees <- read.tree(system.file("extdata", "3firstFritzTrees.tre", package = "FestR"))
#than the bird trees
bird_trees   <- read.tree(system.file("extdata", "3firstJetzTrees.tre", package = "FestR"))

#combine them together using the tree.bind function from the mulTree package
combined_trees<-tree.bind(x = mammal_trees, y = bird_trees, sample = 2, root.age = 250)
```

\subsection{Testing the new data: \texttt{set.tef.est}}
In order to estimate a trophic enrichment factor for a new species we need to 
check that the species is already present in our phylogeny and check what data is available
for the new species.

This data set.tef.est checks for includes:

tissue type ("blood", "claws", "collagen", "feather", "hair", "kidney", "liver", "milk", "muscle"), 

habitat ("terrestial", "marine"), 

diet.type ("carnivore", "herbivore", "omnivore", "pellet"), 

and the isotopic ratios of the food sources for carbon 

(source.iso.13C) 

and nitrogen 

(source.iso.15N).
```{r}
#####function that checks the dat for some species we want to estimate TEF for
new.data.test <- setTefEst(species = "Meles_meles", 
                             habitat = "terrestrial", 
                             taxonomic.class = "mammalia", 
                             tissue = "blood", 
                             diet.type = "omnivore", 
                             source.iso.13C = c(-24.1), 
                             source.iso.15N = c(7.0), 
                             tree = combined_trees)
```

If the species is not in the phylogeny already such as the Komodo dragon (Varanus komodoensis), or we are missing on of the values, in this case diet.type we get warning messages to indicate what is missing from our data.
```{r, echo=FALSE}
#####function that checks the dat for some species we want to estimate TEF for
new.data.dummy <- setTefEst(species = "Varanus_komodoensis", 
                             habitat = "terrestrial", 
                             taxonomic.class = "mammalia", 
                             tissue = "blood", 
                             diet.type = "omnivore", 
                             source.iso.13C = c(-24.1), 
                             source.iso.15N = c(7.0), 
                             tree = combined_trees)
```


\subsection{Formating the new data: \texttt{tef.mul.clean}}
We now need to format the data by combining both the isotpic data already avialbe within the package and the data from the new species and matching these species to the included phylogeny. We also include what isotope we want to estimate a trophic discrimination value for (either "carbon" or "nitrogen").

```{r}
tef_data_c <- tefMulClean(new.data = new.data.test, data = mydata, species.col.name = "species", tree =  combined_trees, taxonomic.class = "mammalia", isotope = "carbon" )
```

We now have a mulTree class object, which is required by the imputation analysis, that contains the matched phylogeny and a dataset containting isotpic data with the new species for which you want to estimate a trophic enrichment factor at the top with a NA for either delta13C or delta15N depending on isotope.

```{r}
tef_data_c$phy
head(tef_data_c$data)
```


\subsection{Running the analysis: \texttt{tef.mul.clean}}

With the data formated as a mulTree object we now need to set up the model. In this case we will run the full model to esstimate delta13C with the fixed factors
of source isotpic ratio, diet type and habitat type.
```{r}
formula.c <- delta13C ~ source.iso.13C + diet.type + habitat
```
and random terms that includes the "animal" term which is required to include phylogeny into the analysis, sp.col to allow multiple species entries into the analysis and account for variation within a species, and tissue type.

```{r}
random.terms = ~ animal + sp.col + tissue
```

As we rely on Bayesian imputation to estimate the missing value we also need to speciafy a prior, in this case we follow the standard prior from MCMCglmm

```{r}
prior_tef <- list(R = list(V = 1/4, nu=0.002), G = list(G1=list(V = 1/4, nu=0.002),
					G2=list(V = 1/4, nu=0.002), G3=list(V = 1/4, nu=0.002)))
```

finally we can run the analysis
```{r}
Tef_est.c <- tefMcmcglmm(mulTree.data = tef_data_c, 
                         formula = formula.c, 
                         random.terms = random.terms, 
                         prior = prior_tef, 
                         output = "test_c_run", 
                         nitt = c(1200000),  
                         thin = c(500),
                         burnin = c(200000), 
                         no.chains = c(2), 
                         convergence =  c(1.1), 
                         ESS = c(1000))
```

explain what is going on here

```{r}
hist(Tef_est.c$tef_global)
median(Tef_est.c$tef_global)
```

